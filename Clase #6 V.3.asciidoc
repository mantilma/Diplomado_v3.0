# Bitcoin come riserva di valore e come rete di pagamento

- **La doppia spesa:** 
Quando qualcuno invia la stessa "moneta" due volte.
- ESEMPIO

- Supponiamo che Sarah deve a Bill e Tom 0,2 BTC, ma possiede esattamente 0,2 BTC nel portafoglio. Crea due transazioni simultanee in cui invia 0,2 BTC a Bill e anche 0,2 BTC a Tom. È come se avesse scritto una mail dichiarando il suo amore e l'avesse inviata a due persone contemporaneamente. 
    
    - Le due transazioni non saranno confermate dalla rete! Questo sarebbe un esempio di doppia spesa. Ma se abbiamo un sistema in cui nessun computer è responsabile, come si fa a decidere quale transazione viene rifiutata e quale viene scritta in modo permanente nella blockchain? Bitcoin utilizza un processo chiamato **mining**.

## **Il problema della doppia spesa**

Prima di entrare nel dettaglio, consideriamo quanto segue:

*Bitcoin è denaro digitale*. Ciò significa che, a differenza del denaro convenzionale,

- Non può essere duplicato come altri tipi di file digitali (foto, video, ecc.),
    - replicato, falsificato e/o inviato a più persone contemporaneamente,
    - o fatturato con doppio addebito come può accadere tramite carta di credito.

*Quali vantaggi porta questa funzionalità del Bitcoin?* Spieghiamolo con un esempio.

- È comune per le persone conservare le proprie ricevute e/o tenere un registro delle proprie spese
- Esse confrontano periodicamente i loro conti con i saldi bancari
- e verificano che non ci siano delle discrepanze.

Per esempio:

- Qualcuno potrebbe rendersi conto che un ristorante ha addebitato due volte la propria carta di credito;
- Ci sono due prelievi di 5,08 $ il 26/01/22. Gli è stata addebitata due volte la stessa spesa per il pranzo
- Contatta la banca per cercare di cancellare uno dei due pagamenti,
- Nel caso migliore, se la banca accetta la sua contestazione, riavrà i soldi in pochi mesi.
- Nel caso peggiore, il ristorante si oppone alla restituzione del denaro, sostenendo che ci sono stati 2 acquisti.

Continuiamo ad esplorare esempi quotidiani per illustrare il concetto di "doppia spesa"

Giorno #1:

- Supponiamo che Raquel ordina un pranzo da McDonald's per 10$.
- Paga in contanti con due banconote da 5$.
- Il pagamento è confermato all'istante
    - entrambe le parti hanno partecipato in presenza fisica alla transazione.
        - ed è stato uno scambio facile.
- Semplicemente, un hamburger in cambio dei soldi.

Giorno #2:

- Raquel ordina lo stesso pranzo e ha di nuovo due banconote da 5 dollari,
- ma una è originale e l'altra è falsificata (una copia esatta). Consegna le due banconote come forma di pagamento.
- Le banconote hanno lo stesso numero di serie:
    - il cassiere potrebbe facilmente vedere che una banconata è falsificata,
    - oppure, non accorgendosene, accettare il pagamento come accaduto il giorno prima.
- Il cassiere, avendo passato una giornata intensa di lavoro, accetta il pagamento senza controllare le banconote

Giorno #3 (A Raquel è andata bene, ma ha paura di tornare nuovamente al McDonalds) 

- Ora proverà a duplicare il suo bitcoin come ha fatto con la banconata utilizzata al McDonalds.
- Lei deve 0.2BTC sia a Jaime che a Pepe, ma ha solo 0,2 BTC nel suo wallet.
- Raquel apre il suo wallet installato sia nel suo smartphone che in quello di sua madre con il seed di recupero
- Dal suo smartphone invia 0,2 BTC a Jaime
- Dallo smartphone di sua madre invia 0,2 BTC a Pepe
- Si assicura di inviare le due transazioni esattamente nello stesso momento.
- Due nodi diversi ricevono le due transazioni
    - Ricordiamo che Raquel aveva solo 0,2 BTC da spendere nel suo wallet.

- I nodi di rete se ne accorgono ed una delle due transazioni viene rifiutata!
- In che modo? Se abbiamo un sistema in cui nessun computer è al comando, come si decide quale transazione rifiutare e quale lasciare inalterata sulla blockchain?

- Per raggiungere questo obiettivo, Satoshi Nakamoto è riuscito a trovare un meccanismo che:
    - controlla se una transazione è valida o meno,
    - in maniera consensuale tra tutti i partecipanti alla rete,
    - prima di aggiungerla alla blockchain
- Una soluzione brillante ai problemi sopra menzionati

*Come funziona?*

## Gruppo/Pool di memoria o mempool

- Prima che qualsiasi transazione possa essere eseguita e inserita in un blocco,
    - entrerà in un'area di attesa chiamata "mempool" (pool di memoria).

*****Che cos'è e cosa succede alle transazioni nel pool di memoria?*

- Un'area dove ci sono migliaia di transazioni verificate ma non ancora confermate
- Non esiste un Mempool globale; ciascuno dei nodi deve:
    - verificare la validità delle transazioni prima di includerle nel loro mempool
    - propagare le transazioni verificate ai nodi vicini
    - rifiutare le transazioni non valide

Qui https://dailyblockchain.github.io/  si può visualizzare quanto velocemente le transazioni valide vengono propagate da un nodo all'altro.
 


- Los nodos deben decidir si las transacciones son válidas o no
    - Si son aceptadas,
        - esperan que un minero la seleccione y las adicione en el siguiente bloque
            - eventualmente se graban **permanentemente** en la base de datos compartida,
    - De lo contrario, se pueden rechazar si :
        - existe un conflicto con otra transacción,
        - si no hay suficientes fondos para transferir o
        - si la firma no es válida y no puede comprobar que se puede gastar dicho BTC,
    - Algunas transacciones simplemente se quedan en el área de espera
        - por hasta 72 horas, hasta que por fin se rechazan
            - ya que no agregan un incentivo monetario suficientemente atractivo

La mempool proporciona una capa adicional de seguridad y resistencia contra *ataques DDoS.*  

- cuando una red se inunda con transacciones minúsculas,
    - provocando una congestión inmanejable.

## Actividad-Transacciones Verificadas pero no Confirmadas

https://bits.monospace.live/

https://chainflyer.bitflyer.jp/

A continuación podemos ver una transacción real sin confirmar:

- Un identificador único ( la huella digital de la transacción),
- el espacio de memoria que ocupa,
- la comisión que se paga
- el monto de la transferencia
    
    TxID: a434948b2de9de18398294f84e42436ec59fb86faf34a21052bd640a97cd94b7d
    ___input	⟶. ___outputs
    Size: _____ vbytes (Espacio de memoria que ocupa)
    Fee rate: 27.01 sats/vbyte (Rata de Comisión/ vbyte actual)
    Fee: ______sats (Comisión de la transacción)
    Total value: ₿ _______ ≈ $ ______USD (Valor total de la transacción)
    

Podríamos analizar otra u otras transacciones? 

- Es de mayor o menor monto?
- Los participantes pagaron una comisión más alta o más baja?
- Cual transacción será más probable encontrar en el siguiente bloque? Porqué?
- Qué querrá decir cuando un bloque se cae hacia el abismo?
- Que quiere decir cuando se confirma una transacción?…. Próxima clase

## **La Red de Bitcoin (On-Chain)**

- Está compuesta por los nodos de Bitcoin…
    - Aquellos equipos computacionales que se adhieren a un sistema de reglas (Bitcoin Core).
        - Se comunican entre sí a través del ciberespacio convirtiéndolos en una red.
            - Cada uno de los cuales ejecuta su propia versión del software Bitcoin.


Desde estos puntos de conexión se puede crear, enviar, y recibir información (i.e. transacciones)

- Existen diferentes tipos de nodos; cada uno ejerce un papel diferente en la red

## Nodos Completos

- Ejecutan el software de bitcoin

Tienen autonomía de tomar sus propias decisiones, sin embargo, a través del consenso,

- toman las mismas decisiones, convirtiéndolos en una red descentralizada confiable y segura
- Los nodos completos tienen tres funciones:
    1. **Compartir información (a sus nodos vecinos)**


- [ ]  Hay dos tipos de transacciones que comparten los nodos:
    1. *Transacciones frescas*: 
    - Estas van directamente a la mempool**.**
    - Los nodos se encargan de verificar o rechazar estas transacciones.
        - Se basan en el historial de la blockchain y el conjunto de reglas del software
    - Retransmiten las transacciones válidas a sus nodos vecinos
        - Nadie quiere recibir transacciones defectuosas o maliciosas

b. *Transacciones confirmadas*: 

- transacciones que han sido "**confirmadas**" y escritas en un bloque.
- Estas se agrupan y forman los bloques; no se comparten individualmente.


1. **Guardar una copia de las transacciones confirmadas.** 
- Mantienen una copia completa de todos los bloques en la cadena de bloque,
- Cada **confirmación** reduce exponencialmente *e*l riesgo de que la transacción sea revertida .

https://mempool.space/ (Los bloques morados -debajo están todas las transacciones)

1. **Validar los bloques y llegar a un consenso con los otros nodos.** 
- Todos los nodos participantes deben aceptar unánimemente la información que contiene un bloque entero antes de incluirlo en la cadena de bloques.
- Una copia de la cadena de bloques para su custodia y la comparte con otros nodos.

El estatus de sus transacciones frescas y confirmadas se pueden localizar en la red. Cómo ?

- Los exploradores de bloques son una ventana a todas las transacciones cadena de bloques
- Permiten comprobar el saldo de cada dirección, ver los detalles de cada transacción y más

**Actividad**:    

Exploremos uno de ellos:

https://www.blockchain.com/explorer?view=btc

Vamos al link de Bitcoin donde podemos observar: 

- el monto total que se transmite,
- cuantas entradas y salidas hay
- el tamaño (o la memoria que ocupa en el bloque),
- el ID de una transacción aleatoria
- el estado de la transacción y,
- si la transacción ya ha sido confirmada, muestra el número total de confirmaciones.

-Latest Transactions= Últimas Transacciones

-Latest Blocks=Últimos Bloques

Qué información reconoces? Cual te sorprende? Cuál es el valor de la última  transacción? Podemos ver si ya está confirmada?

- no todos los usuarios tienen suficiente espacio en su disco duro para convertirse en uno
    - de ser ese el caso, simplemente se puede descargar un monedero
        - y realizar transferencias o guardar BTC a largo plazo

### Software -**Bitcoin Core**:

Software original creado por Satoshi Nakamoto-

- Diseñado para conectarse a otras personas que ejecutan el mismo programa,
    - creando una red de computadoras que se comunican entre sí.
- Su propósito es que al descargarlo, todos trabajen con el mismo conjunto de reglas
    - para validar transacciones
    - y contribuir con la seguridad y la descentralización del sistema
- Quien lo ejecute, puede instalarlo como cualquier otro programa de computador
    - descarga y crea una copia adicional de la cadena entera de bloques,
    - puede ayudar a transmitir transacciones a otras computadoras.
- Siempre y cuando haya acceso a internet, no se necesita ningún permiso para:
    - descargarlo y/o utilizarlo libremente
    - transferir bitcoin a otro monedero o recibir de alguien más,
    - verificar de forma demostrable la emisión de la oferta,
    - conocer el historial de transacciones y los propietarios de cada bitcoin.
    

💡 **Código fuente abierto:** Cualquier persona puede ver, **proponer cambios**, **modificar** y distribuir como mejor le parezca. Es comparable a ir a un restaurante y tener acceso a las recetas de tus comidas favoritas (el código)… pero luego puedes hacerlas y agregar o quitar cualquier ingrediente que desees y perfeccionarlas.


- Decenas de expertos en software y criptografía, trabajan en su mantenimiento y mejora.
- Quien propone una actualización en el software,
    - requiere el consenso de la mayoría de los para implementarla

### **“Lightning Network” (Off-Chain):**

## **Cuál es la diferencia entre la Capa 1  o Capas Base y la Capa 2?**

¿Qué haces con una carretera segura pero congestionada? Simple: conectas una carretera para descargar el tráfico. Esta es exactamente la diferencia entre las redes blockchain de Capa 1 y Capa 2.

- Muchas piezas tecnológicas importantes de Bitcoin e incluso muchas transacciones no ocurren dentro de la "cadena de bloques"
- **Bitcoin** es revolucionario ya que es  la ***capa base*** del internet descentralizado, pero,
    - tiene un problema fundamental de escalabilidad.
    - Las transacciones de Bitcoin pueden ser lentas y caras.
        - Se argumenta que bitcoin no se puede usar como medio de pago
            - por ser lento y caro en micro pagos.
                - Existen transacciones de US$1 o US$2 que terminan costando más de US$5 cuando se usa la red principal.
                - Visa procesa hasta 65.000 transacciones por segundo,
                    - mientras que la red Bitcoin solo puede manejar 7 tps.

Ahí es donde la magia de las *soluciones de **capa dos*,** como **Lightning**, ha venido al rescate.

- Con Lightning Network, Bitcoin tiene el potencial de ser la moneda de la era digital…
    - rápida, inmutable y descentralizada.

https://youtu.be/lD8WQbS8-T8

- **Lightning**, es un conjunto de reglas (contratos inteligentes), construido encima de Bitcoin,
    - que permite transacciones instantáneas,
    - de alto volumen y
    - desconectadas de la red principal.
    - No es necesario registrar todas las transacciones en la red,
    - sino en una red alterna más eficiente.
    - Brinda toda la seguridad de Bitcoin sin algunos de sus inconvenientes
        - pero con diferentes tipos de compensaciones
    - Ofrece más privacidad.
    - Lightning aborda los problemas de escalabilidad de Bitcoin.



**Analogía:**

- Un huésped se registra en un hotel; de anticipado le piden su tarjeta de crédito
    - para cubrir los cargos de habitación y tarifas imprevistas de la estadía.
- Es más eficiente y menos costoso que cargar la tarjeta cada vez que incurre en un gasto.
- El hotel lleva un registro de todos los gastos de el cliente.
    - Existe una farmacia y una peluquería independientes dentro del hotel
        - El huésped compra productos, usa servicios y firma la deuda a su habitación.
        - El hotel cobra una comisión por intermediar el pago entre el huésped y el negocio.
- Si el huésped tiene algún problema o una queja,
    - se le descuenta la cantidad necesaria de su cuenta
- La tarjeta sólo se carga después de la estadía
    - cuando el huésped haya verificado que los cargos y el saldo sean correctos.

**Lightning Network** funciona de manera similar pero diferente. Cómo  así?

- La analogía es precisa con la exclusión de la necesidad de confianza
    - Este es un malentendido muy común de LN: no es un sistema de crédito.
        - Las transacciones de LN no son pagarés:
            - son transacciones de Bitcoin válidas que mueven UTXO reales
- En lugar de darle a alguien una tarjeta de crédito y dejar una cuenta abierta,
    - dos nodos pueden abrir un **canal de pago, o** una ruta de transferencia
    - Las partes pueden realizar tantas transacciones  veces como lo deseen,
        - manteniendo su saldo siempre actualizado.
    - Cuanto más grande un canal,
        - mayor la cantidad de bitcoin que se puede transferir en ambas direcciones
    - Se puede construir rutas con todos aquellos con los que se hacen transacciones.
    - Cuantos más canales,
        - más conexiones y mejores atajos para llegar a ciertos destinos.
    - Si existe una ruta directa,
        - todo es sencillo y se hace una transaccion segun el tamaño del canal.
    - Si la conexión es a través de un tercero (un puente),
        - se debe pagar un peaje por pasar
    - Para abrir un canal nuevo, ambos nodos pagan un fee pequeño a los mineros
        - No se necesita actualizar y verificar cada transacción en la red,
            - Esto sería costoso y tomaría mucho tiempo.
        - Por el contrario, se aprueba cada movimiento con ambas firmas digitales
    - Cuando cualquiera de las partes decide cerrar el canal,
        - puede transmitir unilateralmente la última transacción a la red Bitcoin.

Mira una visualización:

https://lnrouter.app/graph/zero-base-fee

- Si A tiene un canal abierto con B y B tiene un canal abierto con C, A puede enviar BTC a C a través de B sin necesidad de confiar o conocer a B.

Actividad:

Miremos un simulador:
https://www.robtex.com/lnemulator.html?conf=A5-5B,B5-5C&send=A2C

- El uso de Lightning es tan barato y rápido como el envío de un correo electrónico
    - con el beneficio adicional de la naturaleza segura y sin confianza de Bitcoin.
        - Sólo las dos personas que mantienen dinero en un canal abierto saben
            - cuánto, qué tan a menudo y cuándo se mueve ese dinero.



- En comparación, si se hacen 3 transacciones “en cadena”, es decir,
    - se quedan en la  capa base,
        - hubieran sido mucho más lentas y caras.
- Cada una de estas transacciones tendría que involucrar a todos los participantes de la red
    - Se podría visualizar de la siguiente manera:
    
   

